# Домашнее задание №7

Снять дамп обращения к веб-серверу, проанализировать пакеты (начиная с первого). Описать на примере снятого дампа, как устанавливается сессия TCP. Настроить в iptables policy DROP, прописать разрешения только на нужные порты и протоколы.

Цель: в результате выполнения ДЗ вы получите базовые навыки работы с iptables и tcpdump.

В данном задании тренируются навыки:

- анализ пакетов данных;
- фильтрация траффика;
- восстановление конфигурации фильтрации траффика после перезагрузки ОС.

Необходимо:

- собрать дамп пакетов с определенного IP и проанализовать их;
- проанализовать нужные порты назначения и адреса источников для дальнейшей фильтрации траффика;
- настроить разрешения в iptables;
- сделать автовосстановление правил фильтрации после перезагрузки ОС.

# Ход работы

Работа выполняется на CentOS 7.

## Установка tcpdump

Устанавливаем `tcpdump` из одноименного пакета:

```bash
sudo yum install tcpdump
```
## Демонстрация установки TCP-сессии

Для демонстрации процесса установки TCP-сессии соберем входящие и исходящие пакеты с порта 80: ` tcpdump -nnn port 80`. В дампе идет установка
одного соединения.

```
# Входящий пакет с флагом SYN
16:22:57.957660 IP 10.100.102.4.46022 > 10.100.102.10.80: Flags [S], seq 3733233394, win 64240, options [mss 1460,sackOK,TS val 1111289652 ecr 0,nop,wscale 7], length 0

# Исходящий пакет с флагами SYN+ACK, подтверждающий прием SYN
16:22:57.957714 IP 10.100.102.10.80 > 10.100.102.4.46022: Flags [S.], seq 2658170832, ack 3733233395, win 28960, options [mss 1460,sackOK,TS val 251288941 ecr 1111289652,nop,wscale 7], length 0

# Входящий пакет с флагом ACK, TCP-сессия установлена
16:22:57.957768 IP 10.100.102.4.46022 > 10.100.102.10.80: Flags [.], ack 1, win 502, options [nop,nop,TS val 1111289652 ecr 251288941], length 0
```
С этого момента TCP-сессия установлена и возможна передача данных между клиентом и сервером по протоколу TCP/IP.

## Сбор дампа пакетов с определенного IP

Соберем 20 пакетов, принятых с адреса `$IPADDR` и запишем в файл для дальнейшего анализа:

```bash
tcpdump 'src $IPADDR' -c 20 -w packets.pcap
```
